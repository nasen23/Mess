# Mess小游戏开发文档

###成员介绍

- 杨松霖，2017013581，github账号：yangsl17
- 那森，2017013574，github账号：nasen23

### 游戏开发背景

###### 游戏选题

 这次实验是要设计一款手机游戏，在搜寻灵感的时候我们发现，在一个国外的游戏设计大赛上，有一款名为Leaving Room的游戏，我们借鉴了此游戏的一些灵感，开发了这款Mess小游戏。值得说明的是，除了借鉴了原作的创意以及使用了原作中主角的相关图片素材，其余所有的逻辑、代码、素材等都是我们独立完成，没有参考原作的成果。

###### 游戏简介

Mess是一款休闲闯关类游戏，基本玩法类似于传统游戏华容道，玩家通过挪动主角和方块，最终使主角在设定的位置走出而通关。与传统华容道不同的是Mess中添加了重力，方块和主角在没有支撑的情况下会下掉。游戏中所有操作模式只有拖动方块。

###### 开发环境

- IDE： Cocos Creator v2.0.10
- 编程语言: JavaScript
- 操作系统: Windows 10 & MacOS 10.14
- 上传工具:微信开发者工具web

###### 小游戏二维码

![QRcode](https://user-images.githubusercontent.com/52596266/61890658-79ec3d00-af3a-11e9-9d44-dba949dc736a.jpg)

### 游戏设计与功能

###### 游戏名称：Mess

###### 玩法介绍

Mess是闯关类的休闲益智游戏，在游戏中玩家的唯一操作方式是拖动方块。在游戏中，主角和其他方块都是规则的矩形，通过挪动移出空间来让主角从特定位置的出口出去是唯一的通关方式。

###### 元素介绍

游戏的元素分为两类，一类是主角元素，一类是障碍物元素。

主角元素：![me1](https://user-images.githubusercontent.com/52596266/61890624-6e991180-af3a-11e9-95a1-edbbf26f7d0f.png)me，是2X2的方块，是最基本的主角；

​                   ![she1](https://user-images.githubusercontent.com/52596266/61890670-81134b00-af3a-11e9-8520-e715f58933dc.png)she，是2X2的方块，出现在第二章；

​                   ![me_baby1](https://user-images.githubusercontent.com/52596266/61890617-6b058a80-af3a-11e9-93d6-2309f69a2bd9.png)me_baby，是1X1的方块，出现在第三章；

​                   ![me_old1](https://user-images.githubusercontent.com/52596266/61890629-7062d500-af3a-11e9-99dc-a63467ae2122.png)me_old，是2X2的方块，出现在第四章；

障碍物元素：![object3](https://user-images.githubusercontent.com/52596266/61890645-7789e300-af3a-11e9-9b7a-d622839c7ed6.png)   ![object2](https://user-images.githubusercontent.com/52596266/61890640-75c01f80-af3a-11e9-98fc-2f461ea2178d.png)如图是1X2和1X1的障碍物方块，还有2X1，2X2，3X1，1X3共6种方块；

主角元素和障碍物元素组合形成关卡。完整版的关卡示例（关卡17）如图：

![level17](https://user-images.githubusercontent.com/52596266/61890613-67720380-af3a-11e9-8130-459ac98a99c4.png)

###### 关卡介绍

游戏总共设计了40关，每10关为一个章节。每个章节的十个关卡中，除了为剧情服务的一些关卡，剩下的关卡在难度上都是越来越难的。难度的越来越高主要是靠更大的地图、更多的障碍物、更难的障碍物类型（更多使用较难处理的1X3和3X1方块）来实现的。

第一章主要是让玩家适应基本的操作模式，关卡设计以难度向为主，剧情上主要讲述男主角不爱整理房间，房间越来越乱，关卡难度也因此递增；第二章，剧情上主角和喜欢的人（She）结婚，两人同居后发现女朋友很懒惰，同样不喜欢打扫房间，反应到游戏中就是，每关会多出一个方块She，无法移动，作为障碍物；第三章，男主角和女主角有了自己的孩子，他们教孩子一些道理，希望孩子能更好地生活，因此这一关特点是主角变成1X1的me_baby；第四章讲述主角年老之后的生活，因为年老没办法再跳跃，所以这一章在操作时主角不能够向上移动，只能水平移动。

### 界面布局和设计

本游戏的主题是主角在年老后回顾自己的一生，因此为了追求平淡地记叙的效果，在页面设计上我们都追求的是简约风格，使用灰色为主的色调，使用同调但风格略微不同的背景音乐，按钮等的设计也尽可能地简单。下面分别介绍主菜单、关卡选择界面和游戏界面的布局设计。

###### 主菜单界面

主菜单界面左侧是主角的图像，添加了简单的动画效果。右侧从上至下依次是游戏名称、游戏简介、开始游戏按钮。点击开始游戏按钮进入关卡选择界面。

###### 关卡选择界面

![choiceMenu](https://user-images.githubusercontent.com/52596266/61890601-617c2280-af3a-11e9-9fe5-f17a74e025bf.jpg)

关卡选择界面由分割线分成四块，每块包含了该章节对应主题的图片以及进入该章节游戏的按钮。四个按钮分别进入1、11、21、31关。通过游戏界面的返回按钮返回至关卡选择界面时，界面正中会出现continue按钮，使玩家可以返回当前关卡继续游戏。

###### 游戏界面

![level1](https://user-images.githubusercontent.com/52596266/61890607-63de7c80-af3a-11e9-9a2d-7cb9cc6c4586.jpg)

以上是level1的界面。

在游戏界面中，正中的游戏框是根据地图的规模动态生成的。在游戏框的下方有一行文字，主要讲述游戏剧情。界面的左上角有两个按钮分别表示return和restart。点击return可以返回关卡选择界面，点击restart重新开始当前关卡（因为有时会出现方块走死的情况）。

### 重点部分的具体实现

###### 关卡的生成与加载

首先是关卡信息的储存。关卡信息全部存储在levelInfo.js文件中，通过`levels`数组储存。每一个关卡信息包含了地图大小、背景音乐、剧情文本信息、方块分布、主角大小以及出口位置和方向。添加关卡时直接在`levels`数组里添加后续关卡信息即可。

在生成关卡时，game.js中调用`load()`函数，在该函数中分别执行读取关卡信息、计算地图大小并绘制、计算方块大小并根据方块分布绘制、更改剧情文本、更改背景音乐等操作。

###### 拖动方块的动作实现

为游戏场景添加针对事件`cc.Node.EventType.TOUCH_START`和`cc.Node.EventType.TOUCH_MOVE`的事件监听。若触摸点的位置处于某个方块中，则处理该拖动事件，令该方块移动一定（合理）的距离。如果某个方块与某个网格的距离小于`attract_dist`，会将该方块定在这个网格上，这样感官上有类似“吸附”的效果。

###### 碰撞检测

这个其实不是很好做，因为各个方块所占的位置是离散的，但同时为了操作手感，必须保证方块能够连续地移动。

为了实现这样的碰撞检测，需要用一个数组记录哪些位置被方块所占领了，即`map`。每次方块被移动时，都要通过`isGridEmpty(node, x, y)`判断方块所到达的位置是否能够放得下这个方块。如果不能的话，就利用`normalizedPos(node, delta, oldPos)`来找到一个既能放得下该方块，又符合当前拖动方向的位置。

停止触屏时，会将方块放入一个最近的合适位置中，并检查是否有悬空的方块，然后令悬空的方块掉落。

###### 界面间的切换

本游戏中由于所有的关卡都是绘制在同一个game场景中，所以不同场景之间的切换只有通过按钮来完成。最开始我们使用`cc.director.loadScene()`来进行场景之间的切换，后来为了增加淡入和淡出的动画效果，我们使用了自己定义的`window.sceneAnimator`。

关于关卡之间的切换。我们使用了全局变量`global.level`来储存当前进行的关卡序号。在判断主角成功逃出即当前关卡通关时，全局变量`global.level += 1`表示进入下一关，之后根据level信息重绘game场景达到进入下一关的目的。

### 小组分工

- 那森：绘制游戏界面、根据关卡信息生成游戏场景、游戏主逻辑

- 杨松霖：主界面和选择界面的设计、所有关卡的设计、按钮的设计、部分运动函数的编写。